<head></head>
<body>
<script>
let hostname = location.hostname
let port = '8080'
// hostname = 'localhost'

// 上传
function upload(blob) {
    var formData = new FormData()
    formData.append('file', blob)
    fetch('http://localhost:8080/api/file/upload', { method: 'POST', body: formData })
}

// 监听图片输入
 function fileChange(e) { 
    let evt = e || window.event; 
    let file = evt.target.files[0]; 
    let reader = new FileReader(); 
    let rs = reader.readAsArrayBuffer(file); 
    let blob = null; 
    reader.onload = (e) => { 
        console.log(file)
        if (typeof e.target.result === 'object') { 
            blob = new Blob([e.target.result], {
                name: file.name,
                type: file.type
            }) 
        } else { 
            blob = e.target.result
        } 
        // upload(blob)
        upload(file)
        console.log(Object.prototype.toString.call(blob)); 
    }
}
    // 预览图片
    function preView(url) {
        let reader = new FileReader();

        getImageBlob(url, function (blob) {
            reader.readAsDataURL(blob);
        });

        reader.onload = function (e) {
            var img = document.createElement("img");
            img.src = e.target.result;
            document.body.appendChild(img);
        }
    }
    //获取图片的Blob值
    function getImageBlob(url, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open("get", url, true);
        xhr.responseType = "blob";
        xhr.onload = function () {
            if (this.status == 200) {
                if (cb) cb(this.response);
            }
        };
        xhr.send();
    }
        var forceDownload = function (blob, filename) {
            var a = document.createElement('a');
            a.download = filename;
            a.href = blob;
            document.body.appendChild(a)
            a.click();
        }

        // Current blob size limit is around 500MB for browsers
        var downloadResource = function (url, filename) {
            if (!filename) filename = url.split('\\').pop().split('/').pop();
            fetch(url, {
                headers: new Headers({
                    'Origin': location.origin
                }),
                mode: 'cors'
            })
                .then(response => response.blob())
                .then(blob => {
                    let blobUrl = window.URL.createObjectURL(blob);
                    forceDownload(blobUrl, filename);
                })
                .catch(e => console.error(e));
        }
        downloadResource('http://' + hostname + ':' + port + '/api/file/1', 'test.jpg')
        preView('http://' + hostname + ':' + port + '/api/file/1')
        function getURL () {
            return 'http://' + hostname + ':' + port + '/api/file/info'
        }
        function getPreviewUrl(fileId) {
            preView('http://' + hostname + ':' + port + '/api/file/' + fileId)
        }
        function previewAll () {
            fetch (getURL(), {
                method: 'GET'
            }).then((response) => {
                return response.json()
            }).then((response) => {
                response.reverse().forEach(function(element) {
                    preView(getPreviewUrl(element.id))
                }, this);
            })
        }
        previewAll()
</script>
<style>
    img {
        width: 50px;
        height: 50px;
        display: block;
    }
</style>
    <input type='file' onchange="fileChange()" ></input>
    <button class='form-button'></button>
    <script>
    document.getElementsByClassName('form-button')[0].addEventListener('click', () => {
        
    })
    </script>
</body>